import { Dispatch, SetStateAction, useEffect, useState } from "react";
import {
  UseFormRegister,
  FieldErrors,
  UseFormHandleSubmit,
  useForm,
  SubmitHandler,
} from "react-hook-form";
import { FormRequire, PaymentRequire } from "@/shared/types";
import useSecretaryContext from "@/views/secretary/context/useSecretaryContext";

const useInputForm = (): {
  isTax: boolean;
  setTax: Dispatch<SetStateAction<boolean>>;
  register: UseFormRegister<FormRequire>;
  handleSubmit: UseFormHandleSubmit<FormRequire>;
  errors: FieldErrors<FormRequire>;
  onSubmit: SubmitHandler<FormRequire>;
  isChecked: boolean;
  setChecked: Dispatch<SetStateAction<boolean>>;
} => {
  const [isTax, setTax] = useState<boolean>(false);
  const [isChecked, setChecked] = useState<boolean>(false);
  const {
    getFetchData,
    paymentFetchData,
    paymentPostMutate,
    postMutate,
    scrollRef,
    isComplexPayment,
  } = useSecretaryContext();
  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<FormRequire>();

  useEffect(() => {
    if (!isComplexPayment) {
      setTax(false);
      setChecked(false);
    } else {
      setTax(true);
      setChecked(true);
    }
  }, [isComplexPayment, setTax, setChecked]);

  useEffect(() => {
    console.log("ðŸŽ¯isTax", isTax);
    console.log("ðŸŽ¯isComplexPayment", isComplexPayment);
  }, [isTax, isComplexPayment]);

  const onSubmit: SubmitHandler<FormRequire> = async (data) => {
    try {
      console.log("ðŸŽ¯í˜„ìž¬ ìƒíƒœ:", { isTax, isComplexPayment, isChecked });
      const costPrice = data.costPrice * data.count; //ì›ê°€ ê¸ˆì•¡
      const salePrice = data.salePrice * data.count; //íŒë§¤ ê¸ˆì•¡
      let profit = salePrice - costPrice; //ì´ìµ ê¸ˆ
      let salePriceTax = salePrice;

      console.log("ðŸŽ¯profit", profit);

      if (!isComplexPayment) {
        if (isTax) {
          // profit = profit - profit * 0.1;
          console.log("ðŸŽ¯profit - isTax", profit);
          salePriceTax =
            Number(data.cardPrice) -
            Number(data.cardPrice) * 0.1 +
            Number(data.cashPrice);
          console.log("ðŸŽ¯salePriceTax", salePriceTax);
          profit = salePriceTax - costPrice;
        }
      }

      /**profit í•„ë“œ ì¶”ê°€ */
      let payload = {
        count: data.count,
        item: data.item,
        profit,
        costPrice,
        salePrice: salePriceTax,
        type: isTax,
      };

      const ledgerResult = await postMutate(payload);
      console.log("ðŸŽ¯isChecked", isChecked);

      // 2. Payment ìš”ì²­ ì¤€ë¹„, ë³µí•©ê²°ì œ ì‚¬ìš© ì‹œ
      // paymentì—ì„œ isTax ë‚´ë¶€ ê³„ì‚°ì´ ë™ìž‘í•˜ì§€ ì•ŠëŠ”ë‹¤.
      if (isComplexPayment) {
        console.log("ðŸŽ¯isComplexPayment");
        /**profit í•„ë“œ ì¶”ê°€ */
        payload = {
          count: data.count,
          item: data.item,
          profit,
          costPrice,
          salePrice: salePriceTax,
          type: isTax,
        };
        if (isTax) {
          // profit = profit - profit * 0.1;
          console.log("ðŸŽ¯complexPayment profit", profit);
          salePriceTax =
            Number(data.cardPrice) -
            Number(data.cardPrice) * 0.1 +
            Number(data.cashPrice);
          console.log("ðŸŽ¯salePriceTax", salePriceTax);
          profit = salePriceTax - costPrice;
        }

        const ledgerId = ledgerResult.data[0].id;
        console.log("ðŸŽ¯ledgerResult", ledgerResult.data[0].id);

        // Payment ìš”ì²­ ì‹¤íŒ¨ì‹œ throw Error
        if (!ledgerResult || !ledgerId) {
          throw new Error("ë‹¤ì¤‘ ê²°ì œ ë“±ë¡ ì‹¤íŒ¨");
        }
        const paymentPayload: PaymentRequire[] = [
          {
            ledgerId,
            type: "card",
            price: Number(data.cardPrice),
            profit: Number(data.cardPrice) - Number(data.cardPrice) * 0.1,
          },
          {
            ledgerId,
            type: "cash",
            price: Number(data.cashPrice),
            profit: Number(data.cashPrice),
          },
        ];

        console.log("ðŸŽ¯paymentPayload", paymentPayload);
        const paymentResult = await paymentPostMutate(paymentPayload);
        console.log("ðŸŽ¯paymentResult", paymentResult);
      } //if (isComplexPayment)

      // ì´ê±° ì™œ ìžˆì§€?
      await getFetchData();
      await paymentFetchData();

      reset();

      // ìŠ¤í¬ë¡¤ í•¨ìˆ˜ ë¶„ë¦¬ í•„ìš”
      setTimeout(() => {
        if (scrollRef.current) {
          scrollRef.current?.scrollTo({
            top: scrollRef.current.scrollHeight + 100,
            behavior: "smooth",
          });
          // console.log("ðŸŽ¯scrollRef.current", scrollRef.current);
        } else {
          console.log("ðŸŽ¯scrollRef.current is null");
        }
      }, 200);
    } catch (error: unknown) {
      if (error instanceof Error) {
        console.error(error.message);
      } else {
        console.error("ì˜ˆì™¸ íƒ€ìž… Error", String(error));
        throw error;
      }
    }
  };
  return {
    isTax,
    setTax,
    register,
    handleSubmit,
    errors,
    onSubmit,
    isChecked,
    setChecked,
  };
};

export default useInputForm;
